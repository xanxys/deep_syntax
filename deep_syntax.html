<!doctype html>
<html>
<head>
	<meta charset="utf-8"/>
<title>Deep Syntax Editor</title>
<!-- <link rel="stylesheet" href="static/dashboard.css"/> -->
</head>
<body>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
	<script src="./underscore.js"></script>
<style>
@import url(http://fonts.googleapis.com/css?family=Orbitron);

/* overall layout */
.column{
	display: table-cell;
	width: 40em;
	padding: 2em;
	border-left: 1px dotted gray;
}

/* common codeblock */
div{
	font-family: monospace;
}

.quote{
	border-radius: 5px;
	box-shadow: rgba(0,0,0,0.2) 0 0 5px inset;
	
	position: relative;
	display: inline-block;
	vertical-align: top;
}

.p_keyword{
	color: #00a;
}

.p_string{
	color: #f80;
}

.p_number{
	color: #88a;
}

.s_plain{
	background-color: white;
}

.s_javascript{
	background-color: #fffaf5;
}

.s_html{
	background-color: #fafaff;
}

/* deep syntax */
.current_syntax{
	position: absolute;
	top: 0.1em;
	left: 0.1em;

	font-size: 50%;
	color: #888;
	font-family: 'Orbitron', sans-serif;
}

/* deep syntax live */
.editor{
	font-family: monospace;
	font-size: 12px;
	width: 40em;
	height: 10em;
}
.editor .line{
	min-height: 15px;
}
textarea.editor{
	border:none;
	resize:none;
	padding: 0;
	line-height: 15px;
}
.children{
	margin-left: 1em;
}
</style>

<div class="row">
	<div class="column">
		<h1>古典的表示</h1>

		<div class="quote s_javascript">
			<div class="line">
			<span class="p_keyword">var</span> x = <span class="p_string">"&lt;div&gt;一行目\n\"二行目\"&lt;/div&gt;"</span>;
		</div>
		<div class="line">
		alert();
	</div>
		</div>
	</div>

	<div class="column">
		<h1>深いシンタックス</h1>
		
		<div class="quote s_javascript" title="javascript">
			<div class="line">
				<span class="p_keyword">var</span> x =
				<div class="quote s_html" title="HTML in string">
					<div class="line">&lt;<span class="p_keyword">div</span>&gt;</div>
					<div class="line">一行目</div>
					<div class="line">"二行目"</div>
					<div class="line">
					
						<div class="line">&lt;/<span class="p_keyword">div</span>&gt;</div>
					</div>
				</div>;
			</div>
			<div class="line">alert();</div>
	</div>
</div>

<div>
	<h1>demo</h1>
	<div style="position:relative">
		<div class="editor quote" style="" id="hl"></div>
		<br/>

		<textarea class="editor quote" id="org"></textarea>
	</div>
</div>

<script>
var curr_target = null;
$(document).ready(function(){
	make_editable($('#hl'));
	curr_target = $('#hl');
});

$('#org').keyup(function(e){
	var text = $('#org').val();
	curr_target.data('raw',text);
	sync_layer(js_syntax, curr_target, text);
});

function make_editable(target){
	target.click(function(e){
		console.log('focusing on',target);
		curr_target = target;
		$('#org').val(target.data('raw'));
		return false;
	});
}

function sync_layer(syntax, target, source_str){
	var text=source_str;

	target.empty();
	target.addClass('s_'+syntax.name);

	// create spec table
    var type_to_spec = {};
    _.each(js_syntax.token_specs, function(spec){
    	type_to_spec[spec.type] = spec;
    });

    // 
    _.each(text.split('\n'), function(str){
		var ts = tokenize(js_syntax.token_specs, str);
		
		var line = $('<div class="line"/>');
		var pe=0;
		_.each(ts, function(t){
			var spec = type_to_spec[t.type];

			while(pe<t.begin){
				line.append('&nbsp;');
				pe+=1;
			}
			
			if(spec.escape){
				var raw_str = spec.f_unescape(t.body);

				// create new layer
				var hl = $('<div/>').attr('class','quote').text(raw_str).data('raw',raw_str);
				line.append(hl);
				sync_layer(js_syntax, hl, raw_str);

				make_editable(hl);
			}
			else{
				var hl = $('<span/>').attr('class','p_'+t.type).text(t.body);
				line.append(hl);
			}
			pe = t.end;
		});
		target.append(line);
	});
}




// return token as ranges
// "ab cd" -> [{begin:0, end:2, type:'id'}, {begin:3, end:5, type:'id'}]]
// returned ranges are non-overlapping and in descending order.
function tokenize(token_specs, line){
	function word_to_tokens_by_rest(word){
		if(word.is_token){
			word.type = _.first(token_specs).type;
			return word;
		}
		else{
			return _.map(tokenize(_.rest(token_specs), word.body),
				function(sub_token){
					sub_token.begin += word.begin;
					sub_token.end += word.begin;
					return sub_token;
				});
		}
	}

	if(token_specs.length>0){
		return _.flatten(_.map(
			tokenize1(_.first(token_specs).pattern, line),
			word_to_tokens_by_rest));
	}
	else
		return [];
}

// return ranges
function tokenize1(pattern, phrase){
	var offset = 0;
	var words = [];
	while(phrase.length>0){
		var res = pattern.exec(phrase);
		if(res){
			if(res.index>0){
				words.push({
					is_token: false,
					begin: offset,
					end: offset+res.index,
					body: phrase.slice(0,res.index)
				});
			}

			words.push({
				is_token: true,
				begin: offset+res.index,
				end: offset+res.index+res[0].length,
				body: res[0]
			});

			var doffset = res.index+res[0].length;
			offset += doffset;
			phrase = phrase.slice(doffset);
		}
		else{
			if(phrase.length>0){
				words.push({
					is_token: false,
					begin: offset,
					end: offset+phrase.length,
					body: phrase
				});
				break;
			}
		}
	}

	return words;
}


function guess(){
	return 'plain';
}

js_syntax = {
	name: 'javascript',
	token_specs: [
		{
			type: 'dq',
			escape: true,
			trigger: '"',
			f_escape: function(s){
				return '"'+s+'"';
			},
			f_unescape: function(s){
				return eval(s);
			},
			pattern: /"([^\\"]|\\[\\nt"])*"/
		},
		{
			type: 'sq',
			escape: true,
			trigger: "'",
			f_unescape: function(s){
				return eval(s);
			},
			pattern: /'([^\\']|\\[\\nt'])*'/
		},
		{
			escape: false,
			type: 'delim',
			pattern: /[=+*!$%&(){}<>=-^;\/\-\[\]]/
		},
		{
			escape: false,
			type: 'keyword',
			pattern: /(var|function|return)/
		},
		{
			escape: false,
			type: 'number',
			pattern: /[0-9]+/
		},
		{
			escape: false,
			type: 'identifier',
			pattern: /\S+/
		}
	]
}

html_syntax = {
	name: 'html',
	token_specs: [
		{
			escape: true,
			type: 'attrib',
			pattern: /"([^\\"]|\\[\\nt"])*"/
		},
		{
			escape: false,
			type: 'delim',
			pattern: /[<>\/]/
		},
		{
			escape: false,
			type: 'tag',
			pattern: /(html|body|head|div|span|a|table|script|style|meta|title)/
		},
		{
			escape: false,
			type: 'other',
			pattern: /.+/
		}
	]
}

</script>

</body>
</html>
